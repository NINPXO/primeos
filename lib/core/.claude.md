# Core Module - Database, Router, Services

**Purpose**: Foundational infrastructure for entire app

## Critical Files

| File | Purpose |
|------|---------|
| `database/app_database.dart` | SQLite singleton, FK pragma, migration runner |
| `database/migrations/migration_v1.dart` | Complete 9-table schema (DON'T modify lightly!) |
| `constants/db_constants.dart` | Table/column names (use instead of magic strings) |
| `router/app_router.dart` | GoRouter config, 5-tab navigation |
| `types/app_result.dart` | Sealed AppResult<T> for error handling |
| `providers/database_provider.dart` | FutureProvider<Database> — entry point for all DB access |

## Database Schema Rules

**Never**:
- Add columns without migration
- Change PK types (must stay TEXT/UUID)
- Rename tables (breaks existing queries)

**Always**:
- Update `db_constants.dart` when adding tables/columns
- Maintain FTS5 index on searchable content
- Use soft delete pattern (is_deleted + deleted_at)
- Test migrations with fresh DB init

## Router Rules

**Tab Navigation** (StatefulShellRoute, 5 branches):
```
/ (Dashboard) → GoalsScreen
/daily-log   → DailyLogScreen
/goals       → GoalsScreen
/progress    → ProgressScreen
/notes       → NotesScreen
```

**Modal Routes** (non-tab):
```
/search      → GlobalSearchScreen (fullscreenDialog)
/trash       → TrashScreen
/settings    → SettingsScreen
```

**Adding new route**:
1. Add GoRoute in `app_router.dart`
2. Import screen
3. Test navigation with `context.push()` or `context.go()`

## Services Pattern

All services in `services/`:
- Stateless or singleton
- No direct DB access (use repositories)
- Input validation before DB ops
- Return AppResult<T> or throw custom exceptions

Example: CSV import validates headers before DB writes.

## When to Modify Core

⚠️ **High Risk Areas**:
- Database schema → requires migration
- Router paths → breaks deep links
- AppResult type → affects all error handling

✅ **Safe Areas**:
- Add new constants to `db_constants.dart`
- Add new utility functions to `utils/`
- Add new themes to `theme/`
- Add new error types

## Testing Core Changes

```bash
# After schema change:
flutter run  # Fresh DB init tests migration_v1

# After router change:
flutter run  # Test all 5 tabs + modal routes

# Check imports:
grep -r "import.*core" lib/ | grep -v "db_constants"  # Find magic strings
```

---

**Dependencies**: None (core has no dependencies on features)

**Used By**: All 8 feature modules + settings
