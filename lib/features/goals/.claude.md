# Goals Module - Primary Tracking Feature

**Purpose**: Create, track, and categorize personal goals

**Key Tables**: `goal_categories` (system + user), `goals` (with status)

## Quick Understanding

**Goal Entity**:
```dart
Goal {
  id: UUID,
  categoryId: category_id,
  title: "Learn Rust",
  status: "active" | "paused" | "completed" | "abandoned",
  targetValue: 1000,     // Optional numeric goal
  targetUnit: "pages",   // Optional unit
  targetDate: "2026-12-31",  // Optional deadline
  timestamps
}
```

**GoalCategory**:
- System categories: Learning, Fitness, Nutrition, General (is_system=1)
- User categories: Custom (is_system=0)
- Color support for UI badges

## File Structure

```
data/datasources/goals_local_datasource.dart
  - getAll()
  - getByCategory(categoryId)
  - getById(id)
  - create(goal) + FTS index
  - update(goal) + FTS index
  - softDelete(id) + FTS cleanup
  - Category ops (create, update, etc.)

domain/entities/goal.dart, goal_category.dart
  - Pure Dart, no Flutter

domain/usecases/
  - get_all_goals.dart
  - get_goals_by_category.dart
  - create_goal.dart
  - update_goal.dart
  - soft_delete_goal.dart
  - create_goal_category.dart
  - export_goals_by_category.dart
  - clear_goals_by_category.dart

presentation/providers/goals_provider.dart
  - Watch: all goals, filtered by category
  - Actions: add, update, delete (optimistic)

presentation/screens/goals_screen.dart
  - Tab-based category filter
  - List with FAB for new goal
  - Pull-to-refresh

presentation/widgets/
  - goal_card.dart (swipe to delete)
  - goal_status_badge.dart (active/paused/completed/abandoned)
  - goal_category_tab.dart (FilterChip)
  - category_manage_sheet.dart (add/edit/delete categories)
```

## Adding a New Goal Field

Example: Add `priority` (high/medium/low)

1. **Schema**: Add column in `migration_v1.dart`
   ```sql
   ALTER TABLE goals ADD COLUMN priority TEXT DEFAULT 'medium';
   ```

2. **Entity**: Update `goal.dart`
   ```dart
   @freezed
   class Goal {
     final String priority;  // Add this
   }
   ```

3. **Model**: Update `goal_model.dart`
   ```dart
   'priority': map['priority'] ?? 'medium',
   ```

4. **Datasource**: Update queries in `goals_local_datasource.dart`
   ```dart
   final result = await database.query(..., columns: [..., 'priority']);
   ```

5. **Form**: Add UI picker in `goal_form_screen.dart`

6. **Test**: CRUD cycle with priority set/get

## Common Patterns

**Query with category join**:
```dart
final result = await database.rawQuery('''
  SELECT g.*, gc.${DbConstants.nameColumn}
  FROM ${DbConstants.goalsTable} g
  LEFT JOIN ${DbConstants.goalCategoriesTable} gc
    ON g.${DbConstants.categoryIdColumn} = gc.${DbConstants.idColumn}
  WHERE g.${DbConstants.isDeletedColumn} = 0
''');
```

**FTS Index update**:
```dart
await database.insert(
  'fts_search',
  {
    'source_type': 'goal',
    'source_id': id,
    'title': goal.title,
    'body': '${goal.description} ${goal.status}',
  },
  conflictAlgorithm: ConflictAlgorithm.replace,
);
```

**Optimistic update in provider**:
```dart
state = [
  for (final g in state)
    if (g.id == id) updatedGoal else g
];
await updateUseCase(updatedGoal);  // Fire async
```

## Testing Checklist

- [ ] Create goal with all fields
- [ ] Read goal, verify all fields
- [ ] Update goal, FTS index updated
- [ ] Soft delete goal, appears in trash
- [ ] Restore from trash
- [ ] Hard delete, permanently gone
- [ ] Category filters work
- [ ] Empty state when no goals
- [ ] Search finds goal by title/description
- [ ] Export to CSV, reimport succeeds

## Dependencies

- `core/database` — SQL access
- `core/types` — AppResult<T>
- `core/constants` — db_constants

**Depends On**: Nothing else

**Used By**: progress (goal_id FK), daily_log (auto-logging on goal change), dashboard (aggregates)

---

**When modifying**: Ensure FTS index stays in sync!
