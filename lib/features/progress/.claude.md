# Progress Module - Goal Measurement

**Purpose**: Track numeric progress against goals (values, dates, periods)

**Key Tables**: `progress_entries` (linked to goals via FK)

## Quick Understanding

**ProgressEntry Entity**:
```dart
ProgressEntry {
  id: UUID,
  goalId: FK to goals,
  categoryId: FK to goal_categories (denormalized for speed),
  value: 42.5,        // Numeric measurement
  unit: "pages",      // Optional unit
  note: "Read chapters 5-7",
  trackingPeriod: "daily" | "weekly" | "monthly",
  loggedDate: "2026-02-18",
  timestamps
}
```

**Why categoryId is denormalized**:
- Queries like "sum progress by category" are instant
- No JOIN needed for filtering/exporting
- Must keep in sync with goal's categoryId

## File Structure

```
data/datasources/progress_local_datasource.dart
  - getForGoal(goalId)
  - getByPeriod(period, dateRange)
  - getByCategory(categoryId)
  - aggregateByGoal(goalId) → chart data
  - create(entry) + FTS + auto-log
  - update(entry) + FTS + auto-log
  - softDelete(id) + FTS
  - clearByCategory(categoryId, dateRange)

domain/entities/progress_entry.dart
  - Pure Dart

domain/usecases/
  - get_progress_for_goal.dart
  - get_progress_by_period.dart
  - create_progress_entry.dart
  - update_progress_entry.dart
  - soft_delete_progress.dart
  - export_progress_by_category.dart
  - clear_progress_by_category.dart

presentation/providers/progress_provider.dart
  - Watch: selectedPeriod, filtered entries
  - Watch: aggregated chart data
  - Actions: add, update, delete

presentation/screens/
  - progress_screen.dart (period selector, list)
  - progress_form_screen.dart (goal picker, value input)
  - progress_chart_screen.dart (FL Chart LineChart)

presentation/widgets/
  - progress_entry_card.dart
  - progress_period_selector.dart (daily/weekly/monthly toggle)
  - progress_chart.dart (chart widget)
  - goal_link_picker.dart (dropdown to select goal)
```

## Key Pattern: Denormalization

When creating/updating progress:
```dart
// Always copy categoryId from goal
final goal = await getGoalById(entry.goalId);
final progressToSave = entry.copyWith(
  categoryId: goal.categoryId,  // Denormalize
);
await datasource.create(progressToSave);
```

When goal's category changes:
```dart
// Update all progress entries for that goal
await database.update(
  'progress_entries',
  {'category_id': newCategoryId},
  where: 'goal_id = ? AND is_deleted = 0',
  whereArgs: [goalId],
);
```

## Auto-Logging Integration

When progress entry is created/updated:
```dart
// In use case layer, NOT datasource
final result = await createProgressUseCase(entry);
if (result is Success) {
  // Auto-create daily log entry
  await createDailyLogUseCase(DailyLogEntry(
    logDate: entry.loggedDate,
    categoryId: 'system-auto-log',
    title: 'Progress: ${goal.title}',
    linkedType: 'progress_change',
    linkedId: entry.id,
  ));
}
```

## Chart Data Aggregation

For 7-day chart (LineChart):
```dart
// Query: sum of values grouped by date for last 7 days
final chartData = await datasource.getChartData(
  goalId: goalId,
  startDate: today.subtract(Duration(days: 7)),
  endDate: today,
);
// Returns: [{date: '2026-02-18', total: 42.5}, ...]
```

## Testing Checklist

- [ ] Create entry linked to goal
- [ ] CategoryId matches goal's categoryId
- [ ] Update entry, value/note changes
- [ ] Auto-log created in daily_log table
- [ ] Chart data aggregates correctly (7-day sum)
- [ ] Period filter (daily/weekly/monthly) works
- [ ] Soft delete removes from list but appears in trash
- [ ] Restore works, auto-log restored too
- [ ] Clear by category works (date range select)
- [ ] Export CSV, reimport preserves values
- [ ] Search finds entry by value/note

## Common Mistakes

❌ **Forgetting to sync categoryId**
- Entry created with wrong categoryId
- Dashboard/export queries return wrong data

✅ **Always denormalize**: `categoryId = goal.categoryId`

❌ **Not updating FTS**
- Search doesn't find progress entries

✅ **Call `updateFtsIndex()` on writes**

❌ **Forgetting auto-log**
- User doesn't see progress update in daily log

✅ **Create daily_log_entry in use case**

## Dependencies

- `core/database`
- `core/types`
- `core/constants`
- `features/goals` (goal_id FK)

**Used By**: dashboard (aggregates), daily_log (auto-logged), search (FTS), trash (soft delete queries)

---

**Remember**: Denormalize categoryId to avoid JOINs on every query!
